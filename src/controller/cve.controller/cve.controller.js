const middleware = require('../../middleware/middleware')
const cve_controller = require('../CveController')

async function allocateCveId(req, res) {
    //id_controller.allocateCveId(req, res)
    res.send("NEW-CVE-ID");
}

async function cveSubmission(req, res) {
    // Check API secret to make sure it's valid and avoid open requests
    let cna = req.header('X-API-CNA')
    let author = req.header('X-API-AUTHOR')
    let secret = req.header('X-API-SECRET')
    let error = middleware.validApiSecret(cna, author, secret)
    if (error) {
        return error
    }
    // TODO: implement any additional steps needed to make sure it's safe to parse the JSON
    // Validate CVE JSON against JSON schema to avoid bad data
    let error = middleware.validCveJSON(req.body)
    if (error) {
        return error
    }
    // Parse JSON into CVE
    let cve = JSON.parse(req.body)
    // Make sure Author specified in header matches the JSON before passing to CPS
    if (cve.author != author) {
        return // Return an error that indicates the CVE cannot be submitted
    }
    // Pass CVE submission to CVE controller and therefore CPS
    cve_controller.submitCve(cna, cve)
    res.send("NEW-CVE-SUBMITTED")
}

module.exports = {
    CVE_ID_ALLOCATION: allocateCveId,
    CVE_SUBMISSION: cveSubmission
}