const cveSchema = require('./jsonSchema')
const djv = require('djv');
const env = new djv();
env.addSchema('cve', cveSchema.cveSchema)
const mongoose = require('mongoose')
const user = require('../model/user')
const cna = require('../model/cna')


const validApiSecret = (cna, author, secret) => {
    // Is the Author a user associated with the CNA and is the secret correct.
    // Find the author (username), compare provided CNA id to the user's CNA id. Then compare users secret to provided secret.
    var user, error;
    var User = mongoose.model('User', user);
    User.findOne().byUserName(author).exec(function(err, result) {
        if (err) { error = err };
        user = result;
    })
    if (error) {
        console.log("error in finding username");
        return (error, false)
    }
    if (user.cna != cna) {
        // return error indicating not allowed to submit cve
        return (null, false) 
    }
    if (user.secret != secret) {
        // return error indicating not allowed to submit cve
        return (null, false)
    }
    return (null, true)
}

const validCveJSON = (body) => {
    var error = env.validate('cve', body)
    if (error) {return (error, false)}
    return (null, true)
}

module.exports = {
    validApiSecret: validApiSecret,
    validCveJSON: validCveJSON
};