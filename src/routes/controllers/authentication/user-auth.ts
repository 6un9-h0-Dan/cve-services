import * as jwt from 'jsonwebtoken';
import { dbOperations } from '../../../database/db-operations';

//This auth is using JWT Token. To know more about it visit https://jwt.io/
//In this case, we are assuming logging in is done using a username/password
export const userAuth = async (req, res) => {
    try {
        const { userEmail, userPass } = req['body'];
        dbOperations.userAuthentication(userEmail, userPass).then(
            async resolved => {
                const { userUUID, userEmail, userUName, userOrganizationUUID } = resolved;
                const token = jwt.sign(
                    {
                        userUUID,
                        userEmail,
                        userUName,
                        userOrganizationUUID,
                    },
                    process.env.SECRET_WORD,
                    {
                        expiresIn: 43200, // expires in 12 hours. This should be changed when this moves to production. Should also be moved to env document.
                    },
                );
                await dbOperations.createJWTRecord(token);
                res.status(200).json({ auth: 'true', token });
            },
            rejected => {
                res.status(400).json({ auth: 'false', token: null, error: rejected });
            },
        );
    } catch (err) {
        res.status(400).json({ auth: 'false', token: null });
    }
};
