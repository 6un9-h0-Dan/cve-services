import { dbOperations } from '../../../database/db-operations';
import { getCVEID } from '../../../utils/get-cve-ids';
//TODO: Verify the quota for the User logic
//TODO: Currently using my own CVEID render. Needs to be changed in the future. Current ID style: CVE-YYYY-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
//TODO: Set Organization Name

export const requestCveId = async (req, res) => {
    const { count, status, year, force } = req.body;
    const yearRegex = /^\d{4}$/g;
    const statusRegex = /^(Free|Rejected|Disputed|Populated|Public|Published|Reserved|Obsolete)$/g;
    const forceRegex = /^[0-1]*$/g;
    try {
        if (year) {
            if (!new RegExp(yearRegex).test(year)) {
                res.status(400).json({ error: 'Invalid Year' });
                return;
            }
        }
        if (force) {
            if (!new RegExp(forceRegex).test(force)) {
                res.status(400).json({ error: 'Force value' });
                return;
            }
        }
        if (status) {
            if (!new RegExp(statusRegex).test(status)) {
                res.status(400).json({ error: 'Invalid Status' });
                return;
            }
        }

        let cveidobject = getCVEID.getID(count, year, req, status);
        var result = [];
        for (var i = 0; i < cveidobject.length; i++) {
            var cveIdObject = {
                cve_id: '',
                status: '',
                Requestor: { user_id: '', user_name: '' },
                Organization: { org_id: '', org_name: '' },
                History: 'TBD',
            };
            try {
                let response = await dbOperations.saveCVE(cveidobject[i]);
                cveIdObject.cve_id = response.cveID;
                cveIdObject.status = response.cveStatus;
                cveIdObject.Requestor.user_id = response.cveRequesterUserID;
                cveIdObject.Organization.org_id = response.cveOrganizationUUID;
                cveIdObject.Requestor.user_name = req.userUName;
                result.push(cveIdObject);
            } catch (err) {
                res.status(400).json({ error: 'Something happened!' });
            }
        }
        res.status(200).json(result);
    } catch (err) {
        console.log(err);
        res.status(400).json({ error: 'Something happened!' });
    }
};
